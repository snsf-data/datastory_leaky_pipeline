---
params: 
  title: ""
  publication_date: ""
  doi: ""
output: 
  html_document:
    anchor_sections: false
    theme: null
    highlight: null
    mathjax: null
    css: ["style.css", "https://fonts.googleapis.com/css?family=Source+Sans+Pro:400,700&display=swap"]
    self_contained: true
title: "`r params$title`"
editor_options: 
  chunk_output_type: console
---


```{r general-setup, include=FALSE}
## This file contains the GERMAN version of the data story

# Set general chunk options
knitr::opts_chunk$set(echo = FALSE, fig.showtext = TRUE, fig.retina = 3, 
                      fig.align = "center", warning = FALSE, message = FALSE)

# Install pacman package if needed
if (!require("pacman")) {
  install.packages("pacman")
  library(pacman)
}

# Install snf.datastory package if not available, otherwise load it
if (!require("snf.datastory")) {
  if (!require("devtools")) {
    install.packages("devtools")
    library(devtools)
  }
  install_github("snsf-data/snf.datastory")
  library(snf.datastory)
}

# Load packages
p_load(tidyverse,
       lubridate,
       readxl,
       scales, 
       conflicted, 
       jsonlite,
       here, 
       ggiraph)

# Conflict preferences
conflict_prefer("filter", "dplyr")
conflict_prefer("get_datastory_theme", "snf.datastory")
conflict_prefer("get_datastory_scheme", "snf.datastory")

# Increase showtext package font resolution
showtext_opts(dpi = 320)

# Set the locale for date formatting (Windows)
Sys.setlocale("LC_TIME")

# Create function to print number with local language-specific format 
print_num <- function(x) snf.datastory::print_num(x, lang = "de")

# Knitr hook for local formatting of printed numbers
knitr::knit_hooks$set(
  inline <- function(x) {
    if (!is.numeric(x)) {
      x
    } else {
      print_num(x)
    }
  }
)


```

```{r print-header-infos, results='asis'}
# Add publication date to header
cat(format(as_datetime(params$publication_date), "%d.%m.%Y"))
```

```{r story-specific-setup, include=FALSE, message=FALSE}
# Set story-specific variables etc. here

# Load Career PF data
career_pf_data <- read_csv(here("input/career_pf_data.csv"))

# reorder factors for plotting:
career_pf_data <- career_pf_data %>% 
  mutate(fi = factor(fi, levels = c("Doc.CH", "Doc.Mobility",
                           "Early Postdoc.Mobility", "Postdoc.Mobility",
                           "PRIMA",
                           "Ambizione",  "Eccellenza/ SNSF Professorships",
                           "Project funding")))
# bfs data for 2020:
bfs_data <- read_delim("input/bfs_data.csv", 
    delim = ";", escape_double = FALSE, trim_ws = TRUE)

bfs_data <- bfs_data %>% 
         mutate(Personalkategorie = factor(Personalkategorie, 
                                    levels = c("Assistierende und Doktorierende",
                                               "Wissenschaftliche Mitarbeitende",
                                               "Übrige Dozierende",
                                               "Professor/innen")),
                Personalkategorie = recode_factor(Personalkategorie, 
                                "Assistierende und Doktorierende" = 
                                  "Assistant·es et doctorant·es",
                                "Wissenschaftliche Mitarbeitende" = 
                                  "Collaboratrices et collaborateurs scientifiques",
                                "Übrige Dozierende" = 
                                  "Autres chargé·es d’enseignement",
                                "Professor/innen" = 
                                  "Professeur·es"))

# Decide on colors for research area: (SSH orange - MINT blue - LS violet)
research_area_colors <- get_snsf_scheme()

# compute proportion of f/m applicants by FI and research area
leaky_pipeline_summary <- career_pf_data %>% 
  # exclude PRIMA, which is for women only
  filter(!fi == "PRIMA") %>%
  # subset approved applications
  filter(IsApproved == 1) %>%
  group_by(fi, research_area, ResponsibleApplicantGender) %>%
  summarise(n = n())  %>%
  mutate(prop = n / sum(n))

leaky_pipeline_summary_bfs <- bfs_data %>% 
  filter(!(Geschlecht == "Total")) %>% 
  group_by(Personalkategorie, research_area, Geschlecht)  %>%
  summarise(TotalAmount = sum(Amount, na.rm = TRUE)) %>% 
  mutate(prop = TotalAmount / sum(TotalAmount))

# function to create a leaky pipeline plot per research area
plot_leaky_pipeline <- function(division = "SSH", y_max = 1,
                                title = NULL) {
  div <- case_when(division == "SSH" ~ "SHS",
                   division == "MINT" ~ "MINT",
                   division == "LS" ~ "SV")
  leaky_pipeline_summary <-
    leaky_pipeline_summary %>% 
    mutate(div = div)
  p <- leaky_pipeline_summary %>% 
    filter(research_area == division) %>% 
    ggplot(aes(x = fi, y = prop, color = ResponsibleApplicantGender, 
               group = ResponsibleApplicantGender,
               # Define tooltip text for ggiraph
               tooltip = paste0("Domaine de recherche: ", div, "<br>",
                                "FI: ", fi, "<br>", 
                                "Sexe: ", ResponsibleApplicantGender, "<br>", 
                                "Nombre: ", n, "<br>", 
                                "Proportion: ", paste0(round(prop*100, 1), "%"), "<br>"), 
               # Highlight all of the points with the same color when hovering
               # over it (ggiraph)
               data_id = ResponsibleApplicantGender)) +
    geom_point_interactive(shape = 16, size = 3) + # , 
                           # color = "white") + 
    get_datastory_theme(tick_axis = c("x", "y"), 
                        remove_plot_margin = TRUE) + 
    guides(fill = guide_legend(nrow = 1)) +
    # geom_point(size = 2) + 
    geom_line(linetype = "dashed") +
    labs(title = title, x = NULL, y = NULL) +
    # add line breaks to long labels with 2 words
    scale_x_discrete(labels = function(x) {
      sub("\\s", "\n", x)
    }) +
    scale_y_continuous(labels = scales::label_percent(accuracy = 1),
                       limits = c(0, y_max),
                       breaks = seq(0, 1, by = 0.1)) +
    get_datastory_theme() +
    scale_colour_manual(values = get_datastory_scheme(),
                        labels = c("Femme", "Homme")) +
    theme(axis.text.x = element_text(angle = 45, hjust = 1),
          legend.background = element_rect(color = "transparent",
                                           fill = "transparent"),
          legend.position = c(0.7, 0.95), legend.direction = "horizontal") 
  
  return(p)
}

plot_leaky_pipeline_bfs <- function(division = "SSH", y_max = 1,
                                title = NULL) {
  div <- case_when(division == "SSH" ~ "SHS",
                   division == "MINT" ~ "MINT",
                   division == "LS" ~ "SV")
  leaky_pipeline_summary_bfs <-
    leaky_pipeline_summary_bfs %>% 
    mutate(div = div,
           Geschlecht = case_when(Geschlecht == "Mann" ~ "m",
                                  Geschlecht == "Frau" ~ "f"))
  p <- leaky_pipeline_summary_bfs %>% 
    filter(research_area == division) %>% 
    ggplot(aes(x = Personalkategorie, y = prop, color = Geschlecht, 
               group = Geschlecht,
               # Define tooltip text for ggiraph
               tooltip = paste0("Domaine de recherche: ", div, "<br>",
                                "Catégorie: ", Personalkategorie, "<br>", 
                                "Sexe: ", Geschlecht, "<br>", 
                                "Nombre: ", TotalAmount, "<br>", 
                                "Proportion: ", paste0(round(prop*100, 1), "%"), "<br>"), 
               # Highlight all of the points with the same color when hovering
               # over it (ggiraph)
               data_id = Geschlecht)) +
    geom_point_interactive(shape = 16, size = 3) + # , 
                           # color = "white") + 
    get_datastory_theme(tick_axis = c("x", "y"), 
                        remove_plot_margin = TRUE) + 
    guides(fill = guide_legend(nrow = 1)) +
    # geom_point(size = 2) + 
    geom_line(linetype = "dashed") +
    labs(title = title, x = NULL, y = NULL) +
    # add line breaks to long labels with 2 words
    scale_x_discrete(labels = function(x) {
      str_wrap(x, 20)
    }) +
    scale_y_continuous(labels = scales::label_percent(accuracy = 1),
                       limits = c(0, y_max),
                       breaks = seq(0, 1, by = 0.1)) +
    get_datastory_theme() +
    scale_colour_manual(values = get_datastory_scheme(),
                        labels = c("Femme", "Homme")) +
    theme(#axis.text.x = element_text(hjust = 1),
          legend.background = element_rect(color = "transparent",
                                           fill = "transparent"),
          legend.position = c(0.7, 0.95), legend.direction = "horizontal") 
  
  return(p)
}

# reporting year start and end
reporting_year_start <- 2018
reporting_year_end <- 2020

division_ssh <- "SSH"
division_ls <- "LS"
division_mint <- "MINT"

```

<!-- Short lead (2-3 sentences) in bold -->

__En Suisse, les étudiantes sont plus nombreuses que les étudiants dans les hautes écoles universitaires. Et pourtant, les femmes occupant une chaire de professeur·e y sont minoritaires. Ce déséquilibre se reflète aussi dans les requêtes que reçoit le FNS.__

La diminution du nombre de femmes au fur et à mesure que sont gravis les échelons de la carrière académique porte le nom de « leaky pipeline » : le tuyau percé ou qui fuit. Les données de l’Office fédéral de la statistique (OFS) de 2020 sont sans ambiguïté : le tuyau fuit dans les universités et les EPF, et ce dans toutes les disciplines. Que ce soit dans les sciences humaines et sociales (SHS) ou les sciences de la vie (SV), les femmes sont majoritaires au début et pendant le cursus d’études. Mais leur part au niveau du professorat ne représente plus que 30 % en SHS et 23 % en SV. Pour les disciplines MINT, la situation de départ est différente : avec 36 %, les étudiantes y sont minoritaires et le pourcentage des femmes est encore divisé par deux parmi les professeur·es, à 18 %.

<div class="plot-box">
<div class="plot-title">Proportion de femmes et d’hommes en SHS dans les universités et EPF suisses (2020)</div>

```{r}
y_max_ssh_bfs <- max(leaky_pipeline_summary_bfs$prop + 0.05)

leaky_pipeline_ssh_bfs <- plot_leaky_pipeline_bfs(division = division_ssh, y_max = y_max_ssh_bfs)

girafe(ggobj = leaky_pipeline_ssh_bfs, 
       height_svg = 4, 
       options = list(
         opts_toolbar(saveaspng = FALSE),
         opts_hover(css = "fill:#ff0000;stroke:#000000;"),
         opts_tooltip(
           css = get_ggiraph_tooltip_css(),
           opacity = 0.6,
           delay_mouseover = 0,
           delay_mouseout = 0
         )
       ))
```
<div class="caption">
<a href="https://www.bfs.admin.ch/bfs/en/home/statistics/education-science/educational-staff/tertiary-higher-institutions/universities.assetdetail.17504434.html" target="_blank">Données de l’OFS</a> sur la proportion de femmes et d’hommes dans la recherche en SHS dans les hautes écoles universitaires suisses, en fonction de la catégorie de personnel (2020).
</div>
</div>


<div class="plot-box">
<div class="plot-title">Proportion de femmes et d’hommes en SV dans les universités et EPF suisses (2020)</div>

```{r}
y_max_ls_bfs <- max(leaky_pipeline_summary_bfs$prop + 0.05)

leaky_pipeline_ls_bfs <- plot_leaky_pipeline_bfs(division = division_ls, y_max = y_max_ls_bfs)

girafe(ggobj = leaky_pipeline_ls_bfs, 
       height_svg = 4, 
       options = list(
         opts_toolbar(saveaspng = FALSE),
         opts_hover(css = "fill:#ff0000;stroke:#000000;"),
         opts_tooltip(
           css = get_ggiraph_tooltip_css(),
           opacity = 0.6,
           delay_mouseover = 0,
           delay_mouseout = 0
         )
       ))
```
<div class="caption">
<a href="https://www.bfs.admin.ch/bfs/en/home/statistics/education-science/educational-staff/tertiary-higher-institutions/universities.assetdetail.17504434.html" target="_blank">Données de l’OFS</a> sur la proportion de femmes et d’hommes dans la recherche en SV dans les hautes écoles universitaires suisses, en fonction de la catégorie de personnel (2020).
</div>
</div>


<div class="plot-box">
<div class="plot-title">Proportion de femmes et d’hommes en MINT dans les universités et EPF suisses (2020)</div>

```{r}
y_max_mint_bfs <- max(leaky_pipeline_summary_bfs$prop + 0.05)

leaky_pipeline_mint_bfs <- plot_leaky_pipeline_bfs(division = division_mint, 
                                                   y_max = y_max_mint_bfs)

girafe(ggobj = leaky_pipeline_mint_bfs, 
       height_svg = 4, 
       options = list(
         opts_toolbar(saveaspng = FALSE),
         opts_hover(css = "fill:#ff0000;stroke:#000000;"),
         opts_tooltip(
           css = get_ggiraph_tooltip_css(),
           opacity = 0.6,
           delay_mouseover = 0,
           delay_mouseout = 0
         )
       ))
```
<div class="caption">
<a href="https://www.bfs.admin.ch/bfs/en/home/statistics/education-science/educational-staff/tertiary-higher-institutions/universities.assetdetail.17504434.html" target="_blank">Données de l’OFS</a> sur la proportion de femmes et d’hommes dans la recherche en MINT dans les hautes écoles universitaires suisses, en fonction de la catégorie de personnel (2020).
</div>
</div>


### Soumission de requêtes au FNS

Le même tableau ressort des données du FNS, et plus précisément du nombre de requêtes reçues de 2018 à 2020. Ces données ne se réfèrent pas directement à l’échelon de la carrière académique des chercheuses et chercheurs, mais à nos instruments d’encouragement. Il est ainsi possible d’estimer à quel niveau se situent les requérant·es. C’est dans les sciences humaines et sociales que la proportion de femmes reste la plus élevée à tous les échelons. On observe néanmoins un net déséquilibre, même dans ce domaine : alors que plus de 60 % des requérant·es sont des femmes dans l’instrument Doc.CH (niveau doctorat), elles ne sont plus que 40 % dans le cadre d’Ambizione (un premier pas vers l’indépendance scientifique). Dans l’encouragement de projets (chercheuses et chercheurs expérimentés), leur part est de 34 %.


<div class="plot-box">
<div class="plot-title">Proportion de femmes et d’hommes parmi les requérant·es en SHS (2018-2020)</div>

```{r, message=FALSE}
# Leaky pipeline in Social Sciences and Humanities (SSH)

y_max_ssh <- max(leaky_pipeline_summary$prop + 0.05)

leaky_pipeline_ssh <- plot_leaky_pipeline(division = division_ssh, 
                                          y_max = y_max_ssh)

girafe(ggobj = leaky_pipeline_ssh, 
       height_svg = 4, 
       options = list(
         opts_toolbar(saveaspng = FALSE),
         opts_hover(css = "fill:#ff0000;stroke:#000000;"),
         opts_tooltip(
           css = get_ggiraph_tooltip_css(),
           opacity = 0.6,
           delay_mouseover = 0,
           delay_mouseout = 0
         )
       ))

```
<div class="caption">
<a href="https://github.com/snsf-data/datastory_leaky_pipeline/tree/main/input" target="_blank">Proportion de femmes et d’hommes parmi les requérant·es dans la recherche en SHS, en fonction de l’instrument d’encouragement du FNS, de `r reporting_year_start` à `r reporting_year_end`</a>. L’instrument d’encouragement Doc.CH n’est proposé qu’en SHS. L’instrument Doc.Mobility n’existe plus depuis septembre 2020 (dernier délai de soumission le 1er septembre 2020).
</div>
</div>


La différence sensible entre les proportions de requérant·es hommes et femmes se retrouve également en sciences de la vie. Pour l’instrument d’encouragement Doc.Mobility, les femmes sont majoritaires à 60 %. Pour Ambizione, leur part s’élève à 40 % comme en SHS et à seulement 26 % dans l’encouragement de projets.

<div class="plot-box">
<div class="plot-title">Proportion de femmes et d’hommes parmi les requérant·es en SV (2018-2020)</div>

```{r}
# Leaky pipeline in Life Sciences (LS)
y_max_ls <- max(leaky_pipeline_summary$prop + 0.05)

leaky_pipeline_ls <- plot_leaky_pipeline(division = division_ls, 
                                         y_max = y_max_ls)

girafe(ggobj = leaky_pipeline_ls, 
       height_svg = 4, 
       options = list(
         opts_toolbar(saveaspng = FALSE),
         opts_hover(css = "fill:#ff0000;stroke:#000000;"),
         opts_tooltip(
           css = get_ggiraph_tooltip_css(),
           opacity = 0.6,
           delay_mouseover = 0,
           delay_mouseout = 0
         )
       ))
```
<div class="caption">
<a href="https://github.com/snsf-data/datastory_leaky_pipeline/tree/main/input" target="_blank">Proportion de femmes et d’hommes parmi les requérant·es dans la recherche en SV, en fonction de l’instrument d’encouragement du FNS, de `r reporting_year_start` à `r reporting_year_end`</a>. L’instrument Doc.Mobility n’existe plus depuis septembre 2020 (dernier délai de soumission le 1er septembre 2020).
</div>
</div>


```{r calculations, message=FALSE}
small_fem_perc_mint <- round(100 * 
  career_pf_data %>% 
  # exclude PRIMA, which is for women only
  filter(!fi == "PRIMA") %>%
  # subset approved applications
  filter(IsApproved == 1) %>%
  group_by(fi, research_area, ResponsibleApplicantGender) %>%
  summarise(n = n())  %>%
  mutate(prop = n / sum(n)) %>% 
  filter(fi == "Project funding", 
         ResponsibleApplicantGender == "f", 
         research_area == "MINT") %>% 
  pull(prop), 2)
```

La situation se présente différemment en mathématiques, informatique, sciences naturelles et technique (MINT). Bien que la proportion de femmes y diminue aussi au fur et à mesure que sont gravis les échelons de la carrière, cette baisse est moins forte que dans les deux autres domaines. Mais ce que l’on remarque dans le domaine des MINT, c’est qu’il n’y a que 27 % de requérantes dès la bourse Doc.Mobility. Ce pourcentage reste relativement stable et ne tombe à 15 % que pour l’encouragement de projets.


<div class="plot-box">
<div class="plot-title">Proportion de femmes et d’hommes parmi les requérant·es en MINT (2018-2020)</div>

```{r}
# Leaky pipeline in MINT

y_max_mint <- max(leaky_pipeline_summary$prop + 0.05)

leaky_pipeline_mint <- plot_leaky_pipeline(division = division_mint, y_max = y_max_mint)

girafe(ggobj = leaky_pipeline_mint, 
       height_svg = 4, 
       options = list(
         opts_toolbar(saveaspng = FALSE),
         opts_hover(css = "fill:#ff0000;stroke:#000000;"),
         opts_tooltip(
           css = get_ggiraph_tooltip_css(),
           opacity = 0.6,
           delay_mouseover = 0,
           delay_mouseout = 0
         )
       ))
```
<div class="caption">
<a href="https://github.com/snsf-data/datastory_leaky_pipeline/tree/main/input" target="_blank">Proportion de femmes et d’hommes parmi les requérant·es dans la recherche en MINT, en fonction de l’instrument d’encouragement du FNS, de `r reporting_year_start` à `r reporting_year_end`</a>. L’instrument Doc.Mobility n’existe plus depuis septembre 2020 (dernier délai de soumission le 1er septembre 2020).
</div>
</div>


```{r, eval=FALSE, include=FALSE}
# import the dataset 
# https://www.bfs.admin.ch/bfs/de/home/statistiken/bildung-wissenschaft/technologie/indikatorsystem/zugang-indikatoren/w-t-input/frauen-und-wissenschaft.assetdetail.14941518.html
# rerun in case of new data (UPDATE THE MASTER LINK!!)
# download.file("https://www.bfs.admin.ch/bfsstatic/dam/assets/19384477/master",
#               "input/women_research.xlsx")

women_research_data <- read_excel(here("input", "women_research.xlsx"),
                                  sheet = "Tablong 10 Stufe", range = "B44:L72")

# clean the data
# this code has to be thoroughly checked in case of new data
women_research_data_cleaned <- women_research_data %>%
  janitor::clean_names() %>%
  # get rid of the empty rows in between
  # filter out every fifth row (the one with the totals)
  filter(row_number() %% 5 != 0,
         # filter out the completely empty rows
         studierende > 0) %>%
  # add the year
  mutate(year = rep(c(2020,2019,2018,2017,2016,2015), times=c(3,3,3,3,3,3))) %>%
  # give shorter and English names to the columns
  rename(gender = x2020,
         Baccalaureate = gymnasiale_maturitat_berufsmaturitat_und_fachmaturitat,
         Admissions = eintritt_in_eine_hochschule,
         Students = studierende,
         Bachelors = bachelors,
         Masters = masters,
         PhDs = doktortitel,
         "Researchers D" = forscher_innen_stufe_d,
         "Researchers C" = forscher_innen_stufe_c,
         "Researchers B" = forscher_innen_stufe_b,
         "Researchers A" = forscher_innen_stufe_a) %>%
  # bring it into long format
  pivot_longer(cols = c(Baccalaureate, Admissions, Students, Bachelors, Masters,
                        PhDs, "Researchers D", "Researchers C", "Researchers B",
                        "Researchers A"),
               names_to = "category",
               values_to = "percentage") %>%
  # transform category to be a factor (for it to appear in the right order
  # afterwards)
  mutate(category = factor(category, levels = c(
    "Baccalaureate", "Admissions", "Students",
    "Bachelors", "Masters", "PhDs", "Researchers D",
    "Researchers C", "Researchers B", "Researchers A")),
    percentage = as.numeric(percentage),
    gender = case_when(
      gender ==  "Frauen" ~ "female",
      gender ==  "Männer" ~ "male",
      gender == "Total" ~ "total"),
    # get the same order of the two genders as in the previous part
    gender = factor(gender, levels = 
                      c("male", "female")))

leaky_pipeline_bfs_full <- women_research_data_cleaned %>%
  filter(gender != "total",
         year == 2020, 
         category %in% c("Masters", "PhDs",
                         "Researchers D",
                         "Researchers C",
                         "Researchers B",
                         "Researchers A")) %>% #, year == params$year_women_researcher) %>%
  mutate(category = fct_recode(category,
                               `Junior Mitarbeiter/innen, Assistenten und Doctorierende Studenten` = 
                                 "Researchers D",
                               `Wissenschaftliche Mitarbeiter/innen und Kollaboratoren` =
                                 "Researchers C",
                               Dozenten = "Researchers B",
                               `Professor/innen` = "Researchers A")) %>% 
  ggplot(aes(x = category,
             y = percentage,
             group = gender,
             color = gender,
             # Define tooltip text for ggiraph
             tooltip = paste0("Personalkat.: ", category, "<br>",
                              "Geschlecht: ", gender, "<br>", 
                              "Anteil: ", paste0(round(percentage*100, 1), "%"), "<br>"), 
             # Highlight all of the points with the same color when hovering
             # over it (ggiraph)
             data_id = gender)) +
  geom_line(linetype = "dashed") +
  geom_point_interactive(shape = 16, size = 3) +  
  # geom_hline(yintercept = 0.5) +
  scale_y_continuous(breaks = seq(0, 1, 0.1),
                     limits = c(0.2, 0.8),
                     labels = scales::percent_format(accuracy = 1)) +
    # add line breaks to long labels with 2 words
    scale_x_discrete(labels = function(x) {
      str_wrap(x, 10)
    }) +
  labs(x = "",
       y = "",
       title = str_wrap("BFS Daten: Anteil an weiblichen und männlichen Akademiker in den unterschiedlichen Personalkategorien (2020)", width = 70)) +
  get_datastory_theme() +
  scale_colour_manual(values = get_datastory_scheme(),
                      labels = c("Male", "Female")) 

girafe(ggobj = leaky_pipeline_bfs_full, 
       height_svg = 4, 
       options = list(
         opts_toolbar(saveaspng = FALSE),
         opts_hover(css = "fill:#ff0000;stroke:#000000;"),
         opts_tooltip(
           css = get_ggiraph_tooltip_css(),
           opacity = 0.6,
           delay_mouseover = 0,
           delay_mouseout = 0
         )
       ))
```

```{r, eval=FALSE, include=FALSE}
# data for 2020:
dat <- read_delim(here("input/px-x-1503040100_101_20211124-163234.csv"), 
                  delim = ";", escape_double = FALSE, 
                  locale = locale(encoding = "WINDOWS-1252"),
                  trim_ws = TRUE)

dat <- dat %>% 
  rename(`n_diplomas` = `Abschlüsse der universitären Hochschulen`) %>% 
  select(-c(Jahr, Hochschule))
map <- openxlsx::read.xlsx(here("input/Leaky_Pipeline_2017-2018.xlsx"), 
                           sheet = "UH_Personal_Total", startRow = 5, 
                           fillMergedCells = T)

map <- map %>% 
  select(`SNF.Abteilung`, Fachrichtung) %>% 
  distinct()

summary_dat <- dat %>% 
  group_by(Examensstufe, Fachrichtung, Geschlecht) %>% 
  summarise(total_diploma = sum(n_diplomas, na.rm = TRUE))

left_out <- anti_join(summary_dat, map, by = "Fachrichtung")
left_out <- unique(left_out$Fachrichtung)

# redifine those not within map:
missing <- data.frame(SNF.Abteiling = c(rep("1", 3), rep("2", 2),
                                        rep("1", 4), rep("2", 2),
                                        rep("1", 3), "NZ",
                                        rep("1", 3), "2",
                                        rep("1", 3), "3",
                                        "2", rep("1", 4),
                                        "2", rep("1", 3)),
                      Fachrichtung = left_out)
names(missing) <- names(map)
map <- rbind(map, missing)

summary_dat_ra <- summary_dat %>% 
  left_join(map, by = "Fachrichtung") %>% 
  filter(!(SNF.Abteilung == "NZ")) %>% 
  mutate(research_area = as.factor(case_when(SNF.Abteilung == "1" ~ "SSH",
                                             SNF.Abteilung == "2" ~ "MINT",
                                             SNF.Abteilung == "3" ~ "LS")),
         research_area = factor(research_area, levels = c("SSH", "MINT", "LS"))) %>% 
  group_by(research_area) %>% 
  group_by(Examensstufe, research_area, Geschlecht)  %>%
  summarise(TotalAmount = sum(total_diploma, na.rm = TRUE)) %>% 
  mutate(prop = TotalAmount / sum(TotalAmount)) %>% 
  rename(category = Examensstufe)
  

leaky_pipeline_summary_bfs <-
  leaky_pipeline_summary_bfs %>% 
  rename(category = Personalkategorie)

all_dat <- rbind(leaky_pipeline_summary_bfs, summary_dat_ra)

all_dat <- all_dat %>% 
  filter(!(category == "Doktorat")) %>% 
  mutate(category = factor(category, levels = c("Master",
                                                # "Doktorat",
                                                "Assistierende und Doktorierende",
                                                "Wissenschaftliche Mitarbeitende",
                                                "Übrige Dozierende",
                                                "Professor/innen")))
```

```{r, eval=FALSE, include=FALSE}
all_dat_plot <- all_dat %>% 
  ggplot(aes(x = category,
             y = prop,
             group = Geschlecht,
             color = Geschlecht,
             # Define tooltip text for ggiraph
             tooltip = paste0("Personalkat.: ", category, "<br>",
                              "Geschlecht: ", Geschlecht, "<br>", 
                              "Anzahl: ", TotalAmount, "<br>",
                              "Anteil: ", paste0(round(prop*100, 1), "%"), "<br>"), 
             # Highlight all of the points with the same color when hovering
             # over it (ggiraph)
             data_id = Geschlecht)) +
  geom_line(linetype = "dashed") +
  geom_point_interactive(shape = 16, size = 3) +  
  # geom_hline(yintercept = 0.5) +
  scale_y_continuous(breaks = seq(0, 1, 0.25),
                     limits = c(0.15, 0.85),
                     labels = scales::percent_format(accuracy = 1)) +
    # add line breaks to long labels with 2 words
    scale_x_discrete(labels = function(x) {
      str_wrap(x, 10)
    }) +
  labs(x = "",
       y = "",
       title = str_wrap("BFS Daten: Anteil an weiblichen und männlichen Akademiker in den unterschiedlichen Akademischen Stufen (2020)", width = 70)) +
  get_datastory_theme() +
  scale_colour_manual(values = get_datastory_scheme(),
                      labels = c("Female", "Male")) +
  facet_wrap(~research_area, nrow = 3)

```

```{r, eval=FALSE, include=FALSE}
girafe(ggobj = all_dat_plot, 
       height_svg = 4, 
       options = list(
         opts_toolbar(saveaspng = FALSE),
         opts_hover(css = "fill:#ff0000;stroke:#000000;"),
         opts_tooltip(
           css = get_ggiraph_tooltip_css(),
           opacity = 0.6,
           delay_mouseover = 0,
           delay_mouseout = 0
         )
       ))
```


### Augmenter la proportion des femmes

Il n’y a donc bien un leaky pipeline même dans les instruments d’encouragement du FNS. La proportion de chercheuses qui soumettent une demande de financement est trop faible aux échelons de carrière les plus avancés. Depuis quelques années, nous essayons de changer les choses grâce à une série de mesures, p. ex. un soutien financier complémentaire aux jeunes parents ou l’ouverture de possibilités de travail à temps partiel dans les projets soutenus par le FNS. Nous encourageons aussi explicitement les femmes à devenir professeures. En outre, nous suivons minutieusement et analysons l’effet de ces actions qui, associées aux mesures dans les hautes écoles, ont pour objectif d’aider un plus grand nombre de femmes à faire carrière dans les sciences.


### Une série sur le gender monitoring au FNS

Le FNS analyse systématiquement la proportion de femmes et d’hommes dans ses instruments d’encouragement. Au moyen de ce gender monitoring, nous entendons développer nos méthodes de sélection et notre offre afin de donner aux femmes des chances égales, dans la mesure du possible. Une sélection de données et différents aspects de cette thématique sont mis en lumière dans une petite série. Partie 1: La place des femmes dans l’encouragement de projets FNS ((Lien vers ce récit de données))

Les données, le texte et le code de ce récit de données sont disponibles sur <a href="https://github.com/snsf-data/datastory_leaky_pipeline" target="_blank">Github</a> et archivés sur <a href="https://doi.org/10.46446/datastory.leaky-pipeline" target="_blank">Zenodo</a>. DOI : 10.46446/datastory.leaky-pipeline